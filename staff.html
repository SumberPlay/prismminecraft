<!DOCTYPE html>
<html lang="ru">
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <meta charset="UTF-8">
    <title>P.R.I.S.M. | Терминал ОС</title>
    <style>
        :root { 
            --term-green: #00ff41; 
            --term-dim: #003b00;
            --alert-red: #ff0000; 
            --bg-dark: #050505; 
        }

        body { 
            background: var(--bg-dark); 
            color: var(--term-green); 
            font-family: 'Courier New', monospace; 
            margin: 0; 
            overflow-x: hidden;
            text-transform: uppercase;
        }

        /* Эффект ЭЛТ-монитора */
        body::before {
            content: " ";
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            background-size: 100% 3px, 3px 100%;
            pointer-events: none; z-index: 1000;
        }

        .cursor { display: inline-block; width: 8px; height: 1.2em; background: var(--term-green); animation: blink 1s infinite; vertical-align: middle; margin-left: 5px; }
        @keyframes blink { 0%, 49% { opacity: 1; } 50%, 100% { opacity: 0; } }

        nav { border-bottom: 1px solid var(--term-green); padding: 15px; background: #000; }
        nav a { color: var(--term-green); text-decoration: none; margin-right: 25px; font-size: 0.9em; opacity: 0.7; transition: 0.3s; }
        nav a:hover { opacity: 1; text-shadow: 0 0 8px var(--term-green); }
        nav a::before { content: "[ "; }
        nav a::after { content: " ]"; }

        .container { max-width: 850px; margin: 40px auto; padding: 25px; border: 1px solid var(--term-dim); position: relative; box-shadow: inset 0 0 20px #000; }
        
        .card { border: 1px solid var(--term-dim); background: rgba(0, 20, 0, 0.2); padding: 25px; margin-bottom: 20px; position: relative; }
        .card::before { content: "БЛОК_ДАННЫХ"; position: absolute; top: -8px; left: 15px; background: var(--bg-dark); padding: 0 10px; font-size: 0.7em; color: var(--term-dim); }

        .btn { 
            background: transparent; border: 1px solid var(--term-green); color: var(--term-green); 
            padding: 12px; width: 100%; cursor: pointer; font-family: inherit;
            text-align: left; transition: 0.2s; margin-bottom: 10px; font-size: 0.9em;
        }
        .btn::before { content: "> ВЫПОЛНИТЬ: "; opacity: 0.6; }
        .btn:hover { background: var(--term-green); color: #000; box-shadow: 0 0 15px var(--term-green); }
        
        .btn-council { border-color: #ffd700; color: #ffd700; }
        .btn-council:hover { background: #ffd700; color: #000; box-shadow: 0 0 15px #ffd700; }

        input, textarea { 
            background: #000; /* Черный фон */
            border: 1px solid var(--term-dim); /* Темно-зеленая рамка */
            color: var(--term-green); /* Светящийся зеленый текст */
            padding: 15px; 
            width: 100%; 
            box-sizing: border-box; 
            outline: none;
            font-family: inherit; 
            margin-bottom: 15px; 
            font-size: 1.1em;
            /* Убираем белое свечение при клике и делаем его зеленым */
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        input:focus, textarea:focus {
            border-color: var(--term-green);
            box-shadow: 0 0 10px var(--term-dim);
        }

        /* Чтобы плейсхолдеры тоже были тускло-зелеными, а не серыми */
        ::placeholder {
            color: var(--term-dim);
            opacity: 0.8;
        }

        #incident-box { border: 2px solid var(--alert-red); padding: 20px; margin: 20px 0; background: rgba(50, 0, 0, 0.3); animation: flash 2s infinite; }
        @keyframes flash { 0% { border-color: var(--alert-red); } 50% { border-color: transparent; } 100% { border-color: var(--alert-red); } }

        .ascii-art { font-size: 8px; line-height: 1; white-space: pre; margin-bottom: 30px; color: var(--term-green); text-shadow: 0 0 5px var(--term-green); }
    </style>
</head>
<body>

<nav>
    <a href="index.html">ГЛАВНАЯ_ДИРЕКТОРИЯ</a>
    <a href="dossier.html">ЛИЧНЫЕ_ДЕЛА</a>
</nav>

<div class="container">
    <div id="system-status-indicator" style="font-size: 0.7em; opacity: 0.6; margin-bottom: 10px;">
        СТАТУС_СВЯЗИ: <span id="sync-val">ПОДКЛЮЧЕНИЕ...</span>
    </div>

    <div id="login-zone">
        <div class="ascii-art">
 ██████╗ ██████╗ ██╗███████╗███╗    ███╗
 ██╔══██╗██╔══██╗██║██╔════╝████╗ ████║
 ██████╔╝██████╔╝██║███████╗██╔████╔██║
 ██╔═══╝ ██╔══██╗██║╚════██║██║╚██╔╝██║
 ██║     ██║  ██║██║███████║██║ ╚═╝ ██║
 ╚═╝     ╚═╝  ╚═╝╚═╝╚══════╝╚═╝     ╚═╝</div>
        <h3 id="login-title">ТРЕБУЕТСЯ_АВТОРИЗАЦИЯ<span class="cursor"></span></h3>
        <div class="card">
            <input type="text" id="uid" placeholder="ID_СОТРУДНИКА">
            <input type="password" id="ups" placeholder="КЛЮЧ_ДОСТУПА">
            <button class="btn" onclick="checkAuth()">ЗАПУСТИТЬ_ПРОТОКОЛ_ВХОДА</button>
            <p id="err" style="color: var(--alert-red); display: none; font-size: 0.8em;">[!] ОШИБКА: ОТКАЗАНО_В_ДОСТУПЕ</p>
        </div>
    </div>

    <div id="staff-content" style="display: none;">
        <div id="user-role" style="font-size: 0.8em; color: var(--term-dim);">УРОВЕНЬ_ДОПУСКА: 0</div>
        <h2 id="greet" style="margin-top: 5px; min-height: 1.2em;"></h2><span id="greet-cursor" class="cursor"></span>
        
        <div id="incident-box" style="display: none;">
            [ ТРЕВОГА ] КРИТИЧЕСКИЙ_СБОЙ: <span id="incident-reason"></span>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 25px 0;" id="buttons-container"></div>

        <div class="card">
            <h3 style="font-size: 0.9em; margin-bottom: 15px;">ПОДАЧА_ОПЕРАТИВНОГО_РАПОРТА</h3>
            <textarea id="reportText" placeholder="ВВЕДИТЕ_ДАННЫЕ_ЛОГА..."></textarea>
            <button onclick="sendReport()" class="btn">ПЕРЕДАТЬ_ПАКЕТ_ДАННЫХ</button>
            <div id="reportStatus"></div>
        </div>

        <button onclick="logout()" style="background:none; border:none; color:var(--term-dim); margin-top:40px; cursor:pointer; width: 100%; font-family: inherit; font-size: 0.7em;">
            >> РАЗОРВАТЬ_СОЕДИНЕНИЕ_ВЫХОД
        </button>
    </div>
</div>

<script>
const RENDER_API = "https://prism-bot.onrender.com";
let staffDB = {};

// 1. Инициализация терминала и загрузка базы
async function initTerminal() {
    try {
        const response = await fetch(`${RENDER_API}/get-staff`);
        staffDB = await response.json();
        document.getElementById('sync-val').innerText = "ONLINE";
        
        // Проверка, если уже залогинены
        const savedUID = sessionStorage.getItem('prism_uid');
        if (savedUID && staffDB[savedUID]) {
            renderDashboard(staffDB[savedUID]);
        }
    } catch (e) {
        document.getElementById('sync-val').innerText = "OFFLINE (ОШИБКА БАЗЫ)";
        document.getElementById('sync-val').style.color = "var(--alert-red)";
    }
}

async function syncSystem() {
    try {
        const response = await fetch(`${RENDER_API}/status`);
        const data = await response.json();
        const syncVal = document.getElementById('sync-val');
        if(syncVal) {
            syncVal.innerText = data.label;
            syncVal.style.color = data.color;
        }

        if (data.state === "RED") {
            document.body.style.color = "var(--alert-red)";
            if (data.reason) {
                document.getElementById('incident-box').style.display = "block";
                document.getElementById('incident-reason').innerText = data.reason.toUpperCase();
            }
        } else {
            document.body.style.color = "var(--term-green)";
            document.getElementById('incident-box').style.display = "none";
        }
    } catch (e) { 
        document.getElementById('sync-val').innerText = "СВЯЗЬ_ПОТЕРЯНА"; 
    }
}

function checkAuth() {
    const id = document.getElementById('uid').value.toUpperCase().trim();
    const ps = document.getElementById('ups').value;
    const user = staffDB[id];

    if (user && CryptoJS.MD5(ps).toString() === user.pass) {
        sessionStorage.setItem('prism_uid', id);
        sessionStorage.setItem('prism_level', user.level);
        
        // Отчет боту
        fetch(`${RENDER_API}/auth-log`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: id, name: user.name, level: user.level })
        });

        renderDashboard(user);
    } else {
        document.getElementById('err').style.display = 'block';
        setTimeout(() => document.getElementById('err').style.display = 'none', 3000);
    }
}

function renderDashboard(user) {
    document.getElementById('login-zone').style.display = 'none';
    document.getElementById('staff-content').style.display = 'block';
    document.getElementById('user-role').innerText = `ДОПУСК: УРОВЕНЬ_${user.level} // РОЛЬ: ${user.role.toUpperCase()}`;
    
    document.getElementById('greet').innerText = `ДОБРО_ПОЖАЛОВАТЬ: ${user.name}`;

    const container = document.getElementById('buttons-container');
    container.innerHTML = "";
    
    const actions = [
        { name: "ЛИЧНОЕ_ДОСЬЕ", link: "profile" },
        { name: "КАРТА_ОБЪЕКТА", link: "map" }
    ];

    if (user.role === "scientific") actions.push({ name: "АРХИВ_АНОМАЛИЙ", link: "archive" });
    if (user.role === "military") actions.push({ name: "ВОЕННЫЕ_ПРОТОКОЛЫ", link: "military_prot" });
    if (user.role === "council") {
        actions.push({ name: "ПОЛНЫЙ_АРХИВ", link: "archive", class: "btn-council" });
        actions.push({ name: "СЕТЬ_ОБОРОНЫ", link: "military_prot", class: "btn-council" });
        actions.push({ name: "СПИСОК_ПЕРСОНАЛА", link: "staff_list", class: "btn-council" }); // Новая кнопка
        actions.push({ name: "КОНТРОЛЬ_СОВЕТА", link: "override", class: "btn-council" });
    }

    actions.forEach(act => {
        const b = document.createElement('button');
        b.className = `btn ${act.class || ''}`;
        b.innerText = act.name;
        b.onclick = () => window.location.href = act.link + ".html";
        container.appendChild(b);
    });
}

async function sendReport() {
    const text = document.getElementById('reportText').value.trim();
    const uid = sessionStorage.getItem('prism_uid') || "НЕИЗВЕСТНО";
    const status = document.getElementById('reportStatus');
    if (!text) return;

    status.innerText = "> ЗАГРУЗКА_НА_СЕРВЕР...";
    try {
        const res = await fetch(`${RENDER_API}/send-report`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user: uid, text: text, timestamp: new Date().toLocaleString() })
        });
        if (res.ok) {
            status.innerText = "> УСПЕХ: ДАННЫЕ_ПЕРЕДАНЫ";
            document.getElementById('reportText').value = "";
        } else { throw new Error(); }
    } catch (e) {
        status.innerText = "> ОШИБКА: СБОЙ_ПЕРЕДАЧИ";
    }
}

function logout() {
    sessionStorage.clear();
    location.reload();
}

// Запуск
document.addEventListener("DOMContentLoaded", () => {
    initTerminal();
    setInterval(syncSystem, 5000);
});
</script>
</body>
</html>


