<!DOCTYPE html>
<html lang="ru">
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <meta charset="UTF-8">
    <title>P.R.I.S.M. | Staff Portal</title>
    <style>
        :root { 
            --neon-green: #00ffcc; 
            --alert-red: #ff4444; 
            --gold: #ffd700;
            --bg-dark: #050505; 
            --panel-bg: #111; 
        }
        body { 
            background: var(--bg-dark); 
            color: #d1d1d1; 
            font-family: 'Courier New', monospace; 
            margin: 0; 
            transition: background 0.5s;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–µ–∂–∏–º–∞ —Ç—Ä–µ–≤–æ–≥–∏ */
        body.alarm-mode { background: #1a0505; }
        body.alarm-mode .card { border-color: var(--alert-red); box-shadow: 0 0 15px rgba(255, 68, 68, 0.1); }

        nav { background: #000; padding: 15px; border-bottom: 1px solid #333; text-align: center; }
        nav a { color: #888; text-decoration: none; text-transform: uppercase; padding: 0 20px; font-size: 0.9em; }
        nav a:hover { color: var(--neon-green); }

        .container { max-width: 800px; margin: 50px auto; padding: 0 20px; }
        .card { background: var(--panel-bg); border: 1px solid #222; padding: 30px; margin-bottom: 20px; position: relative; }
        
        #system-status-indicator {
            text-align: center; font-size: 0.8em; margin-bottom: 20px; letter-spacing: 2px; font-weight: bold;
        }

        input { 
            background: #000; border: 1px solid #333; color: var(--neon-green); 
            padding: 15px; width: 100%; margin-bottom: 20px; box-sizing: border-box; outline: none;
        }
        input:focus { border-color: var(--neon-green); }

        .btn { 
            background: #1a1a1a; border: 1px solid var(--neon-green); color: var(--neon-green); 
            padding: 15px; width: 100%; cursor: pointer; font-weight: bold; 
            text-transform: uppercase; transition: 0.3s; margin-bottom: 10px;
        }
        .btn:hover { background: var(--neon-green); color: #000; box-shadow: 0 0 10px var(--neon-green); }
        
        .btn-council { border-color: var(--gold); color: var(--gold); }
        .btn-council:hover { background: var(--gold); color: #000; box-shadow: 0 0 15px var(--gold); }

        .role-tag { font-size: 0.8em; color: #666; text-transform: uppercase; letter-spacing: 2px; }
        #staff-content { display: none; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; margin-bottom: 30px; }
        
        textarea {
            width: 100%; height: 100px; background: #000; color: #fff; border: 1px solid #333; 
            padding: 10px; font-family: 'Courier New', monospace; box-sizing: border-box; 
            resize: none; margin-top: 10px; outline: none;
        }
        textarea:focus { border-color: var(--neon-green); }
        #reportStatus { font-size: 0.75em; margin-top: 10px; text-align: center; min-height: 1.2em; }
    </style>
</head>
<body>

<nav>
    <a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a>
    <a href="archive.html">–ê—Ä—Ö–∏–≤</a>
</nav>

<div class="container">
    <div id="system-status-indicator">–°–í–Ø–ó–¨ –° –¶–ï–ù–¢–†–û–ú: <span id="sync-val">–ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï...</span></div>

    <div id="login-zone">
        <h2 style="text-align: center; letter-spacing: 3px;">–ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –¢–ï–†–ú–ò–ù–ê–õ–ê</h2>
        <div class="card">
            <input type="text" id="uid" placeholder="ID –°–û–¢–†–£–î–ù–ò–ö–ê">
            <input type="password" id="ups" placeholder="–ü–ê–†–û–õ–¨">
            <button class="btn" onclick="checkAuth()">–í–•–û–î –í –°–ò–°–¢–ï–ú–£</button>
            <p id="err" style="color: var(--alert-red); display: none; text-align: center; font-weight: bold;">–î–û–°–¢–£–ü –ó–ê–ü–†–ï–©–ï–ù</p>
        </div>
    </div>

    <div id="staff-content">
        <div class="role-tag" id="user-role">Access Level: --</div>
        <h2 id="greet" style="margin-top: 5px; color: #fff;">–ó–ê–ì–†–£–ó–ö–ê...</h2>
        <hr style="border: 0; border-bottom: 1px solid #333; margin-bottom: 20px;">

        <div id="incident-box" style="display: none; border: 1px solid #ff4444; background: rgba(255, 68, 68, 0.1); padding: 15px; margin: 20px 0; color: #ff4444;">
            <span style="font-size: 0.8em; opacity: 0.7;">[!] –ü–†–ò–ß–ò–ù–ê –¢–†–ï–í–û–ì–ò:</span>
            <div id="incident-reason" style="font-weight: bold; font-size: 1.2em; margin-top: 5px;"></div>
        </div>

        <div class="grid" id="buttons-container"></div>

        <div class="card" style="border: 1px dashed #444; background: #080808;">
            <h3 style="color: var(--neon-green); margin: 0 0 10px 0; font-size: 1em;">üìù –≠–õ–ï–ö–¢–†–û–ù–ù–´–ô –†–ê–ü–û–†–¢</h3>
            <p style="font-size: 0.75em; color: #666; margin-bottom: 10px;">–ü—Ä—è–º–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Telegram-–±–æ—Ç —à—Ç–∞–±–∞.</p>
            <textarea id="reportText" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è..."></textarea>
            <button onclick="sendReport()" class="btn" style="margin-top: 15px; font-size: 0.85em;">–û–¢–ü–†–ê–í–ò–¢–¨ –í –®–¢–ê–ë</button>
            <div id="reportStatus"></div>
        </div>

        <button onclick="logout()" style="background:none; border:none; color:#444; margin-top:40px; cursor:pointer; width: 100%; font-family: inherit;">[ –ó–ê–í–ï–†–®–ò–¢–¨ –°–ï–ê–ù–° –°–í–Ø–ó–ò ]</button>
    </div>
</div>

<script>
const RENDER_API = "https://prism-bot.onrender.com";

// –ê—É–¥–∏–æ-–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Ä–µ–Ω—ã
const alarmSound = new Audio('alarm.mp3');
alarmSound.loop = true;
alarmSound.volume = 0.2;
let isAlarmPlaying = false;

const staffDB = {
    "M4SK": { pass: "5e03fcd2d70a976a6b026374da5da3f9", role: "scientific", level: 3, name: "–ú—ç–Ω—Å–∏–ö–µ–π–Ω, –ù–ò–î" },
    "KRMP": { pass: "1bf502b835ee007957e558cbb1959ecb", role: "military", level: 2, name: "–ö—Ä–∏–º–ø–∏, –≥–ª–∞–≤–∞ –í–ì–†" },
    "SUMBR": { pass: "8aaa688aadaf78796f5f620a4897eeb3", role: "council", level: 5, name: "–°–∞–º–±–µ—Ä, –í—ã—Å—à–∏–π –°–æ–≤–µ—Ç" },
    "MRYZE": { pass: "b0eee0a274f64e6f5792b85c93321159", role: "council", level: 5, name: "–Æ–∑, –í—ã—Å—à–∏–π –°–æ–≤–µ—Ç" }
};

// 1. –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –° –ë–û–¢–û–ú
async function syncSystem() {
    try {
        const response = await fetch(`${RENDER_API}/status`);
        const data = await response.json();
        
        const syncVal = document.getElementById('sync-val');
        syncVal.innerText = data.label;
        syncVal.style.color = data.color;

        const incidentBox = document.getElementById('incident-box');
        const incidentReason = document.getElementById('incident-reason');

        if (data.state === "RED") {
            document.body.classList.add('alarm-mode');
            
            // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω ‚Äî –∑–∞–ø—É—Å–∫–∞–µ–º –∑–≤—É–∫
            if (sessionStorage.getItem('prism_uid') && !isAlarmPlaying) {
                alarmSound.play().catch(e => console.log("Sound pending interaction..."));
                isAlarmPlaying = true;
            }

            if (data.reason) {
                incidentBox.style.display = "block";
                incidentReason.innerText = data.reason.toUpperCase();
            }
        } else {
            document.body.classList.remove('alarm-mode');
            incidentBox.style.display = "none";
            
            // –í—ã–∫–ª—é—á–∞–µ–º –∑–≤—É–∫
            alarmSound.pause();
            alarmSound.currentTime = 0;
            isAlarmPlaying = false;
        }
    } catch (e) {
        document.getElementById('sync-val').innerText = "OFFLINE";
        document.getElementById('sync-val').style.color = "gray";
        alarmSound.pause();
        isAlarmPlaying = false;
    }
}

// 2. –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø
function checkAuth() {
    const id = document.getElementById('uid').value.toUpperCase().trim();
    const ps = document.getElementById('ups').value;
    const user = staffDB[id];

    if (user) {
        const hashedInput = CryptoJS.MD5(ps).toString(); 

        if (user.pass === hashedInput) {
            sessionStorage.setItem('prism_uid', id); 
            sessionStorage.setItem('prism_level', user.level); 
            renderDashboard(user);
            
            // –ü—ã—Ç–∞–µ–º—Å—è –≤–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∫–ª–∏–∫–∞ –Ω–∞ –∫–Ω–æ–ø–∫—É "–í—Ö–æ–¥", –µ—Å–ª–∏ —É–∂–µ —Ç—Ä–µ–≤–æ–≥–∞
            if (document.body.classList.contains('alarm-mode') && !isAlarmPlaying) {
                alarmSound.play().catch(() => {});
                isAlarmPlaying = true;
            }
        } else { 
            showError(); 
        }
    } else { 
        showError(); 
    }
}

function showError() {
    document.getElementById('err').style.display = 'block';
    setTimeout(() => { document.getElementById('err').style.display = 'none'; }, 3000);
}

// 3. –û–¢–†–ò–°–û–í–ö–ê –ò–ù–¢–ï–†–§–ï–ô–°–ê
function renderDashboard(user) {
    document.getElementById('login-zone').style.display = 'none';
    document.getElementById('staff-content').style.display = 'block';
    document.getElementById('greet').innerText = user.name;
    document.getElementById('user-role').innerText = `Access Level: ${user.role.toUpperCase()} (Lvl ${user.level})`;
    
    const container = document.getElementById('buttons-container');
    container.innerHTML = ""; 

    container.innerHTML += '<button class="btn" onclick="nav(\'profile\')">üë§ –õ–ò–ß–ù–û–ï –î–û–°–¨–ï</button>';
    container.innerHTML += '<button class="btn" onclick="nav(\'map\')">üó∫Ô∏è –ö–ê–†–¢–ê –ö–û–ú–ü–õ–ï–ö–°–û–í</button>';

    if (user.role === "scientific") {
        container.innerHTML += '<button class="btn" onclick="nav(\'archive\')">üìÇ –ê–†–•–ò–í –ê–ù–û–ú–ê–õ–ò–ô</button>';
    } 
    else if (user.role === "military") {
        container.innerHTML += '<button class="btn" onclick="nav(\'military_prot\')">üõ°Ô∏è –í–û–ï–ù–ù–´–ï –ü–†–û–¢–û–ö–û–õ–´</button>';
    } 
    else if (user.role === "council") {
        container.innerHTML += '<button class="btn btn-council" onclick="nav(\'archive\')">üìÇ –í–ï–°–¨ –ê–†–•–ò–í</button>';
        container.innerHTML += '<button class="btn btn-council" onclick="nav(\'military_prot\')">üõ°Ô∏è –û–ë–û–†–û–ù–ê</button>';
        container.innerHTML += '<button class="btn btn-council" style="grid-column: span 2;" onclick="nav(\'override\')">‚öñÔ∏è –ü–†–û–¢–û–ö–û–õ –û–ë–ù–£–õ–ï–ù–ò–Ø</button>';
    }
}

function nav(page) {
    window.location.href = page + ".html";
}

async function sendReport() {
    const text = document.getElementById('reportText').value.trim();
    const uid = sessionStorage.getItem('prism_uid') || "Unknown";
    const statusMsg = document.getElementById('reportStatus');

    if (!text) return;

    statusMsg.innerText = "‚ö° –û–¢–ü–†–ê–í–ö–ê...";
    statusMsg.style.color = "#888";
    
    try {
        const response = await fetch(`${RENDER_API}/send-report`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                user: uid, 
                subject: "Staff Terminal Report", 
                text: text,
                timestamp: new Date().toLocaleString()
            })
        });

        if (response.ok) {
            statusMsg.style.color = "var(--neon-green)";
            statusMsg.innerText = "‚úÖ –†–ê–ü–û–†–¢ –î–û–°–¢–ê–í–õ–ï–ù –í –®–¢–ê–ë";
            document.getElementById('reportText').value = "";
        } else { throw new Error(); }
    } catch (e) {
        statusMsg.style.color = "var(--alert-red)";
        statusMsg.innerText = "‚ö†Ô∏è –û–®–ò–ë–ö–ê –°–ï–¢–ò (–°–ï–†–í–ï–† OFFLINE)";
    }
}

function logout() {
    sessionStorage.clear();
    location.reload(); 
}

// –°–¢–ê–†–¢
setInterval(syncSystem, 3000);
syncSystem();

window.onload = function() {
    const savedUID = sessionStorage.getItem('prism_uid');
    if (savedUID && staffDB[savedUID]) renderDashboard(staffDB[savedUID]);
};
</script>
</body>
</html>
