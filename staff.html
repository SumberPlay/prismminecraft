<!DOCTYPE html>
<html lang="ru">
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <meta charset="UTF-8">
    <title>P.R.I.S.M. | Терминал ОС</title>
    <style>
        :root { 
            --term-green: #00ff41; 
            --term-dim: #003b00;
            --alert-red: #ff0000; 
            --bg-dark: #050505; 
        }

        body { 
            background: var(--bg-dark); 
            color: var(--term-green); 
            font-family: 'Courier New', monospace; 
            margin: 0; 
            overflow-x: hidden;
            text-transform: uppercase;
        }

        body::before {
            content: " ";
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            background-size: 100% 3px, 3px 100%;
            pointer-events: none; z-index: 1000;
        }

        .cursor { display: inline-block; width: 8px; height: 1.2em; background: var(--term-green); animation: blink 1s infinite; vertical-align: middle; margin-left: 5px; }
        @keyframes blink { 0%, 49% { opacity: 1; } 50%, 100% { opacity: 0; } }

        nav { border-bottom: 1px solid var(--term-green); padding: 15px; background: #000; }
        nav a { color: var(--term-green); text-decoration: none; margin-right: 25px; font-size: 0.9em; opacity: 0.7; transition: 0.3s; }
        nav a:hover { opacity: 1; text-shadow: 0 0 8px var(--term-green); }
        nav a::before { content: "[ "; }
        nav a::after { content: " ]"; }

        .container { max-width: 850px; margin: 40px auto; padding: 25px; border: 1px solid var(--term-dim); position: relative; box-shadow: inset 0 0 20px #000; }
        
        .card { border: 1px solid var(--term-dim); background: rgba(0, 20, 0, 0.2); padding: 25px; margin-bottom: 20px; position: relative; }
        .card::before { content: "БЛОК_ДАННЫХ"; position: absolute; top: -8px; left: 15px; background: var(--bg-dark); padding: 0 10px; font-size: 0.7em; color: var(--term-dim); }

        .btn { 
            background: transparent; border: 1px solid var(--term-green); color: var(--term-green); 
            padding: 12px; width: 100%; cursor: pointer; font-family: inherit;
            text-align: left; transition: 0.2s; margin-bottom: 10px; font-size: 0.9em;
        }
        .btn::before { content: "> ВЫПОЛНИТЬ: "; opacity: 0.6; }
        .btn:hover { background: var(--term-green); color: #000; box-shadow: 0 0 15px var(--term-green); }
        
        .btn-council { border-color: #ffd700; color: #ffd700; }
        .btn-council:hover { background: #ffd700; color: #000; box-shadow: 0 0 15px #ffd700; }

        input, textarea { 
            background-color: #000 !important;
            border: 1px solid var(--term-dim) !important;
            color: var(--term-green) !important;
            padding: 15px; width: 100%; box-sizing: border-box; outline: none;
            font-family: 'Courier New', monospace; margin-bottom: 15px; font-size: 1.1em;
            border-radius: 0; appearance: none;
        }

        #incident-box { border: 2px solid var(--alert-red); padding: 20px; margin: 20px 0; background: rgba(50, 0, 0, 0.3); animation: flash 2s infinite; }
        @keyframes flash { 0% { border-color: var(--alert-red); } 50% { border-color: transparent; } 100% { border-color: var(--alert-red); } }

        .ascii-art { font-size: 8px; line-height: 1; white-space: pre; margin-bottom: 30px; color: var(--term-green); text-shadow: 0 0 5px var(--term-green); }
    </style>
</head>
<body>

<nav>
    <a href="index.html">ГЛАВНАЯ_ДИРЕКТОРИЯ</a>
</nav>

<div class="container">
    <div id="system-status-indicator" style="font-size: 0.7em; opacity: 0.6; margin-bottom: 10px;">
        СТАТУС_СВЯЗИ: <span id="sync-val">ПОДКЛЮЧЕНИЕ...</span>
    </div>

    <div id="login-zone">
        <div class="ascii-art">
 ██████╗ ██████╗ ██╗███████╗███╗    ███╗
 ██╔══██╗██╔══██╗██║██╔════╝████╗ ████║
 ██████╔╝██████╔╝██║███████╗██╔████╔██║
 ██╔═══╝ ██╔══██╗██║╚════██║██║╚██╔╝██║
 ██║     ██║  ██║██║███████║██║ ╚═╝ ██║
 ╚═╝     ╚═╝  ╚═╝╚═╝╚══════╝╚═╝     ╚═╝</div>
        <h3 id="login-title">ТРЕБУЕТСЯ_АВТОРИЗАЦИЯ<span class="cursor"></span></h3>
        <div class="card">
            <input type="text" id="uid" placeholder="ID_СОТРУДНИКА">
            <input type="password" id="ups" placeholder="КЛЮЧ_ДОСТУПА">
            <button class="btn" onclick="checkAuth()">ЗАПУСТИТЬ_ПРОТОКОЛ_ВХОДА</button>
            <p id="err" style="color: var(--alert-red); display: none; font-size: 0.8em;">[!] ОШИБКА: ОТКАЗАНО_В_ДОСТУПЕ</p>
        </div>
    </div>

    <div id="staff-content" style="display: none;">
        <div id="user-role" style="font-size: 0.8em; color: var(--term-dim);">ЗАГРУЗКА...</div>
        <h2 id="greet" style="margin-top: 5px; min-height: 1.2em;"></h2><span id="greet-cursor" class="cursor"></span>
        
        <div id="incident-box" style="display: none;">
            [ ТРЕВОГА ] КРИТИЧЕСКИЙ_СБОЙ: <span id="incident-reason"></span>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 25px 0;" id="buttons-container"></div>

        <div class="card">
            <h3 style="font-size: 0.9em; margin-bottom: 15px;">ПОДАЧА_ОПЕРАТИВНОГО_РАПОРТА</h3>
            <textarea id="reportText" placeholder="ВВЕДИТЕ_ДАННЫЕ_ЛОГА..."></textarea>
            <button onclick="sendReport()" class="btn">ПЕРЕДАТЬ_ПАКЕТ_ДАННЫХ</button>
            <div id="reportStatus" style="font-size: 0.8em; margin-top: 10px;"></div>
        </div>

        <button onclick="logout()" style="background:none; border:none; color:var(--term-dim); margin-top:40px; cursor:pointer; width: 100%; font-family: inherit; font-size: 0.7em;">
            >> РАЗОРВАТЬ_СОЕДИНЕНИЕ_ВЫХОД
        </button>
    </div>
</div>

<script>
const RENDER_API = "https://prism-bot.onrender.com";

async function syncSystem() {
    try {
        const response = await fetch(`${RENDER_API}/status`);
        const data = await response.json();
        const syncVal = document.getElementById('sync-val');
        if(syncVal) {
            syncVal.innerText = data.label;
            syncVal.style.color = data.color;
        }

        if (data.state === "RED") {
            document.body.style.setProperty('--term-green', 'var(--alert-red)');
            document.getElementById('incident-box').style.display = "block";
            document.getElementById('incident-reason').innerText = data.reason.toUpperCase();
        } else {
            document.body.style.setProperty('--term-green', '#00ff41');
            document.getElementById('incident-box').style.display = "none";
        }
    } catch (e) { 
        document.getElementById('sync-val').innerText = "СВЯЗЬ_ПОТЕРЯНА"; 
    }
}
function welcomeVoice(name) {
    if (!window.speechSynthesis) return;

    if (window.speechSynthesis.speaking) window.speechSynthesis.cancel();

    const msg = new SpeechSynthesisUtterance();
    msg.text = `Welcome back, operator ${name}. All systems are nominal.`;
    msg.lang = 'en-US';

    // 1. Получаем список всех голосов в системе
    let voices = window.speechSynthesis.getVoices();

    // 2. Ищем мужской голос (David обычно есть во всех Windows)
    // Мы ищем голос, в названии которого есть "David", "Mark", "Google UK English Male" или просто "Male"
    const maleVoice = voices.find(voice => 
        voice.name.includes('David') || 
        voice.name.includes('Mark') || 
        voice.name.includes('Male') ||
        voice.name.includes('Pavel')
    );

    // 3. Если нашли мужской — используем его
    if (maleVoice) {
        msg.voice = maleVoice;
    }

    // Настройки для суровости
    msg.volume = 0.3; // Тихий
    msg.pitch = 0.1;  // Басовитый
    msg.rate = 0.8;   // Медленный

    window.speechSynthesis.speak(msg);

    // Если список голосов еще не загрузился (такое бывает в Chrome)
    if (voices.length === 0) {
        window.speechSynthesis.onvoiceschanged = () => welcomeVoice(name);
    }
}
async function checkAuth() {
    const id = document.getElementById('uid').value.toUpperCase().trim();
    const password = document.getElementById('ups').value; // Берем чистый пароль
    const errorMsg = document.getElementById('err');

    if (!id || !password) return;

    try {
        const response = await fetch(`${RENDER_API}/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id, pass: password }) // Сервер ждет 'pass'
        });

        if (response.ok) {
            const data = await response.json();
            
            // Формируем объект игрока из данных базы
            const userObj = {
                id: id,
                level: data.level,
                name: data.name,
                role: data.role || "СОТРУДНИК"
            };

            // Сохраняем сессию
            localStorage.setItem('prism_user', JSON.stringify(userObj));
            // Запускаем голосовое приветствие
            welcomeVoice(userObj.name);
            // Логируем вход в Telegram через твой сервер
            fetch(`${RENDER_API}/auth-log`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(userObj)
            });

            renderDashboard(userObj);
        } else {
            errorMsg.style.display = 'block';
            errorMsg.innerText = "[!] ОШИБКА: НЕВЕРНЫЙ ИДЕНТИФИКАТОР ИЛИ КЛЮЧ";
            setTimeout(() => errorMsg.style.display = 'none', 3000);
        }
    } catch (e) {
        console.error(e);
        alert("КРИТИЧЕСКАЯ ОШИБКА СВЯЗИ С ЯДРОМ");
    }
}

function renderDashboard(user) {
    document.getElementById('login-zone').style.display = 'none';
    document.getElementById('staff-content').style.display = 'block';
    document.getElementById('user-role').innerText = `ДОПУСК: УРОВЕНЬ_${user.level}`;
    document.getElementById('greet').innerText = `ДОБРО_ПОЖАЛОВАТЬ: ${user.name}`;

    const container = document.getElementById('buttons-container');
    container.innerHTML = "";
    
    const actions = [
        { name: "ЛИЧНОЕ_ДОСЬЕ", link: "profile" }, // Исправлено на правильный файл
        { name: "КАРТА_ОБЪЕКТА", link: "map" },
		{ name: "ПРОТОКОЛЫ", link: "prot" },
		{ name: "АРХИВ", link: "archive" }
    ];

    // Логика кнопок на основе уровня
    if (user.level >= 5) {
        actions.push({ name: "СПИСОК_ПЕРСОНАЛА", link: "staff_list", class: "btn-council" });
        actions.push({ name: "КОНТРОЛЬ_СОВЕТА", link: "override", class: "btn-council" });
    }

    actions.forEach(act => {
        const b = document.createElement('button');
        b.className = `btn ${act.class || ''}`;
        b.innerText = act.name;
        b.onclick = () => window.location.href = act.link + ".html";
        container.appendChild(b);
    });
}

async function sendReport() {
    const text = document.getElementById('reportText').value.trim();
    const status = document.getElementById('reportStatus');
    
    // Достаем данные пользователя правильно
    const savedUser = localStorage.getItem('prism_user');
    const user = savedUser ? JSON.parse(savedUser) : null;

    if (!text || !user) return;

    status.innerText = "> ПОДГОТОВКА ПАКЕТА...";
    try {
        const res = await fetch(`${RENDER_API}/send-report`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                user: user.name, // Отправляем имя сотрудника
                text: text, 
                timestamp: new Date().toLocaleString('ru-RU') 
            })
        });
        if (res.ok) {
            status.innerText = "> УСПЕХ: ЛОГ СОХРАНЕН";
            document.getElementById('reportText').value = "";
            setTimeout(() => status.innerText = "", 3000);
        }
    } catch (e) {
        status.innerText = "> ОШИБКА: КАНАЛ ЗАНЯТ";
    }
}

function logout() {
    // Удаляем данные
    localStorage.removeItem('prism_user');
    // Очищаем старые ключи, если они использовались
    localStorage.removeItem('prism_uid');
    localStorage.removeItem('prism_level');
    localStorage.removeItem('prism_name');
    
    // Перезагружаем, чтобы вернуться к окну логина
    location.reload();
}

window.onload = () => {
    // 1. Запускаем фоновую синхронизацию статуса (RED CODE и т.д.)
    syncSystem();
    setInterval(syncSystem, 5000);
    
    // 2. Проверяем наличие данных в localStorage
    const savedUserData = localStorage.getItem('prism_user');
    
    if (savedUserData) {
        try {
            const user = JSON.parse(savedUserData);
            
            // Если данные есть, сразу отрисовываем личный кабинет
            console.log("Сессия восстановлена для:", user.name);
            renderDashboard(user);
        } catch (e) {
            // Если данные в localStorage повреждены, очищаем их
            console.error("Ошибка парсинга данных сессии");
            localStorage.removeItem('prism_user');
        }
    }
};
</script>
</body>
</html>







