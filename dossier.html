<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>P.R.I.S.M. | ARCHIVE_EXPLORER</title>
    <style>
        :root { 
            --neon: #00ffcc; 
            --alert: #ff4444; 
            --bg: #050505; 
            --panel: rgba(10, 15, 15, 0.95);
            --border: #1a3a3a;
        }

        * { box-sizing: border-box; }
        body { 
            background: var(--bg); color: #888; 
            font-family: 'Courier New', monospace; margin: 0; 
            text-transform: uppercase; font-size: 13px;
            height: 100vh; overflow: hidden;
        }

        .overlay { position: fixed; inset: 0; background: repeating-linear-gradient(0deg, rgba(0,0,0,0.1) 0px, transparent 2px); pointer-events: none; z-index: 1000; }
        .scanline { position: fixed; top: 0; left: 0; width: 100%; height: 4px; background: rgba(0, 255, 204, 0.05); z-index: 1001; pointer-events: none; animation: scan 8s linear infinite; }
        @keyframes scan { from { top: -5%; } to { top: 105%; } }

        nav { 
            position: fixed; top: 0; width: 100%; height: 60px;
            background: #000; border-bottom: 1px solid var(--border);
            display: none; align-items: center; justify-content: center; z-index: 500;
            padding: 0 20px;
        }
        body.authorized nav { display: flex; }
        
        .nav-links { display: flex; gap: 20px; position: absolute; left: 50%; transform: translateX(-50%); }
        nav a { color: #555; text-decoration: none; letter-spacing: 2px; transition: 0.3s; }
        nav a:hover { color: var(--neon); }

        .nav-user-info { margin-left: auto; display: flex; align-items: center; gap: 20px; }
        #user-display { color: #444; font-size: 0.9em; }

        .main-layout {
            display: none;
            grid-template-columns: 350px 1fr;
            height: calc(100vh - 60px);
            margin-top: 60px;
        }
        body.authorized .main-layout { display: grid; }

        .sidebar { border-right: 1px solid var(--border); overflow-y: auto; background: rgba(0,0,0,0.5); padding: 10px; }
        .sidebar::-webkit-scrollbar { width: 4px; }
        .sidebar::-webkit-scrollbar-thumb { background: var(--border); }

        .mini-avatar { 
            width: 40px; height: 40px; 
            border: 1px solid var(--border); 
            filter: grayscale(1); 
            transition: 0.3s ease; 
        }

        .list-item {
            padding: 15px; border: 1px solid transparent; 
            margin-bottom: 5px; cursor: pointer; 
            transition: 0.3s; display: flex; 
            align-items: center; gap: 15px;
            position: relative; overflow: hidden;
        }

        .list-item:hover { 
            background: rgba(0, 255, 204, 0.08); 
            border-color: var(--border);
            padding-left: 20px; 
        }

        .list-item:hover .mini-avatar, .list-item.active .mini-avatar { 
            filter: grayscale(0); 
            border-color: var(--neon);
            box-shadow: 0 0 10px rgba(0, 255, 204, 0.3);
        }

        .list-item.active { 
            background: rgba(0, 255, 204, 0.1); 
            border-color: var(--neon); 
            color: var(--neon); 
        }

        .viewer { padding: 40px; overflow-y: auto; position: relative; }
        .placeholder-text { height: 100%; display: flex; align-items: center; justify-content: center; color: #333; font-size: 1.5em; letter-spacing: 5px; }

        .dossier-content { display: none; animation: fadeIn 0.4s ease-out; }
        .big-photo-frame { width: 200px; height: 200px; border: 1px solid var(--neon); padding: 10px; background: #000; float: left; margin: 0 30px 30px 0; box-shadow: 0 0 20px rgba(0, 255, 204, 0.1); }

        .data-row { margin-bottom: 15px; border-bottom: 1px solid #111; padding-bottom: 5px; }
        .label { color: #555; font-size: 0.8em; }
        .value { color: #fff; font-size: 1.1em; letter-spacing: 1px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .btn-exit { border: 1px solid var(--alert); color: var(--alert); background: none; cursor: pointer; padding: 5px 15px; font-family: inherit; transition: 0.3s; }
        .btn-exit:hover { background: var(--alert); color: #000; }

        #auth-overlay { position: fixed; inset: 0; background: var(--bg); z-index: 5000; display: flex; align-items: center; justify-content: center; }
        .login-card { border: 1px solid var(--neon); padding: 40px; background: #000; text-align: center; width: 400px; position: relative; }
        input { background: rgba(0, 255, 204, 0.05); border: 1px solid var(--border); color: var(--neon); padding: 15px; margin: 10px 0; width: 100%; outline: none; font-family: inherit; }
        .btn { background: rgba(0, 255, 204, 0.1); color: var(--neon); border: 1px solid var(--neon); padding: 15px; cursor: pointer; width: 100%; font-family: inherit; margin-top: 10px; transition: 0.3s; }
        .btn:hover { background: var(--neon); color: #000; }
    </style>
</head>
<body>

<div class="overlay"></div>
<div class="scanline"></div>

<div id="auth-overlay">
    <div class="login-card">
        <h2 style="color: var(--neon); letter-spacing: 5px;">PRISM_LOGIN</h2>
        <input type="text" id="uid" placeholder="PERSONNEL_ID">
        <input type="password" id="ups" placeholder="ACCESS_KEY">
        <button class="btn" onclick="tryLogin('admin')">ACCESS_DATABASE</button>
        <button class="btn" style="border-color: #444; color: #444; background: none;" onclick="tryLogin('guest')">GUEST_ACCESS</button>
    </div>
</div>

<nav>
    <div class="nav-links">
        <a href="index.html">/ MAIN</a>
        <a href="dossier.html" style="color:var(--neon)">/ ARCHIVE_EXPLORER</a>
    </div>
    <div class="nav-user-info">
        <span id="user-display">---</span>
        <button class="btn-exit" onclick="logout()">LOGOUT</button>
    </div>
</nav>

<div class="main-layout">
    <div class="sidebar" id="staff-list"></div>
    
    <div class="viewer" id="staff-viewer">
        <div class="placeholder-text" id="placeholder">SELECT_SUBJECT_FOR_ANALYSIS</div>
        
        <div class="dossier-content" id="content-box">
            <div class="big-photo-frame">
                <img id="v-photo" src="" style="width:100%; filter: grayscale(1);">
            </div>
            
            <div style="margin-bottom: 40px;">
                <h1 id="v-name" style="color:var(--neon); margin:0; font-size:2.5em;"></h1>
                <div id="v-level" style="color:var(--alert); font-weight:bold;"></div>
            </div>

            <div class="data-row">
                <div class="label">ASSIGNED_SECTION</div>
                <div class="value" id="v-dept"></div>
            </div>

            <div class="data-row">
                <div class="label">BIOMETRIC_DATA_&_HISTORY</div>
                <div class="value" id="v-bio" style="white-space: pre-wrap; margin-top:10px; color:#aaa; line-height:1.6;"></div>
            </div>
        </div>
    </div>
</div>

<script>
    const RENDER_URL = "https://prism-bot.onrender.com";
let STAFF_DATA = [];
let typeTimer = null;

// --- АВТОРИЗАЦИЯ ---
async function tryLogin(type) {
    if (type === 'guest') {
        sessionStorage.setItem('prism_level', 1);
        sessionStorage.setItem('prism_user', 'VISITOR_01');
        location.reload(); 
        return;
    }
    
    const id = document.getElementById('uid').value.toUpperCase().trim();
    const pass = document.getElementById('ups').value;

    if (!id || !pass) return alert("FIELDS_REQUIRED");

    try {
        const res = await fetch(`${RENDER_URL}/login`, {
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id, pass })
        });

        const data = await res.json();
        if (data.success) {
            sessionStorage.setItem('prism_level', data.level);
            sessionStorage.setItem('prism_user', data.name);
            location.reload();
        } else { 
            alert("ACCESS_DENIED: INVALID_ID_OR_KEY"); 
        }
    } catch (e) { 
        console.error(e);
        alert("SERVER_OFFLINE"); 
    }
}

// --- ЗАГРУЗКА ДАННЫХ ---
async function loadArchive() {
    const myLevel = parseInt(sessionStorage.getItem('prism_level')) || 1;
    
    document.getElementById('auth-overlay').style.display = 'none';
    document.body.classList.add('authorized');
    document.getElementById('user-display').innerText = `OP: ${sessionStorage.getItem('prism_user')} (L${myLevel})`;

    try {
        const res = await fetch(`${RENDER_URL}/get-staff`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'x-access-level': myLevel
            }
        });

        if (!res.ok) throw new Error("Load Error");
        
        STAFF_DATA = await res.json();
        const listContainer = document.getElementById('staff-list');
        listContainer.innerHTML = ""; 

        if (!STAFF_DATA || STAFF_DATA.length === 0) {
            listContainer.innerHTML = "<div style='padding:20px; color:#444;'>DATABASE_EMPTY</div>";
            return;
        }

        STAFF_DATA.forEach(p => {
            const pLevel = parseInt(p.level) || 1;
            const isLocked = myLevel < pLevel;
            
            const item = document.createElement('div');
            item.className = `list-item ${isLocked ? 'locked' : ''}`;
            
            const nameToShow = isLocked ? "ДАННЫЕ ЗАБЛОКИРОВАНЫ" : (p.display_name || p.name || "UNKNOWN");
            const skinName = isLocked ? "Steve" : (p.mc_name || "Steve");

            item.innerHTML = `
                <img class="mini-avatar" src="https://minotar.net/avatar/${skinName}/40.png" 
                     style="${isLocked ? 'filter: grayscale(1) brightness(0.3) sepia(1) hue-rotate(-50deg);' : ''}">
                <div>
                    <div style="font-weight:bold; color:${isLocked ? 'var(--alert)' : 'var(--neon)'}">
                        ${nameToShow}
                    </div>
                    <div style="font-size:0.7em; color:#555;">
                        ${isLocked ? 'ТРЕБУЕТСЯ ДОПУСК: L' + pLevel : 'CLEARANCE: L' + pLevel}
                    </div>
                </div>
            `;
            
            item.onclick = (event) => selectStaff(p, isLocked, event);
            listContainer.appendChild(item);
        });

    } catch (e) { 
        console.error("Dossier Error:", e);
        document.getElementById('staff-list').innerHTML = `<div style="padding:20px; color:var(--alert);">SYNC_ERROR</div>`;
    }
}

// --- ОТОБРАЖЕНИЕ АНКЕТЫ ---
function selectStaff(p, isLocked, event) {
    if (typeTimer) clearInterval(typeTimer);
    
    document.querySelectorAll('.list-item').forEach(el => el.classList.remove('active'));
    event.currentTarget.classList.add('active');

    document.getElementById('placeholder').style.display = 'none';
    document.getElementById('content-box').style.display = 'block';
    
    const bioEl = document.getElementById('v-bio');
    const nameEl = document.getElementById('v-name');
    const photoEl = document.getElementById('v-photo');
    const deptEl = document.getElementById('v-dept');
    const lvlEl = document.getElementById('v-level');

    if (isLocked) {
        nameEl.innerText = "RESTRICTED_DATA";
        nameEl.style.color = "var(--alert)";
        photoEl.src = "https://minotar.net/armor/bust/Steve/200.png";
        photoEl.style.filter = "brightness(0.1) grayscale(1)";
        deptEl.innerText = "REDACTED";
        lvlEl.innerText = `CRITICAL: LEVEL ${p.level} REQUIRED`;
        startDecryptionEffect(bioEl, "Ошибка доступа. Уровня допуска вашего ключа недостаточно для чтения этого файла. Попытка несанкционированного доступа зафиксирована.");
    } else {
        nameEl.innerText = p.display_name || p.name || p.id;
        nameEl.style.color = "var(--neon)";
        photoEl.src = `https://minotar.net/armor/bust/${p.mc_name || 'Steve'}/200.png`;
        photoEl.style.filter = "grayscale(0)";
        deptEl.innerText = p.dept || "NON_AFFILIATED";
        lvlEl.innerText = `STATUS: AUTHORIZED (L${p.level})`;
        const biography = p.bio || p.description || "Личные данные отсутствуют.";
        startDecryptionEffect(bioEl, biography);
    }
}

// --- ЭФФЕКТЫ ---
function startDecryptionEffect(el, finalText) {
    el.innerHTML = `<span style="color:var(--neon)">[ DECRYPTING: 0% ]</span>`;
    let percent = 0;
    typeTimer = setInterval(() => {
        percent += Math.floor(Math.random() * 20) + 5;
        if (percent >= 100) {
            clearInterval(typeTimer);
            el.innerText = "";
            typeEffect(el, finalText);
        } else {
            el.innerHTML = `<span style="color:var(--neon)">[ DECRYPTING: ${percent}% ]</span>`;
        }
    }, 30);
}

function typeEffect(el, text) {
    let i = 0;
    typeTimer = setInterval(() => {
        el.innerText += text.charAt(i);
        i++;
        if (i >= text.length) {
            clearInterval(typeTimer);
            typeTimer = null;
        }
    }, 15);
}

function logout() { 
    sessionStorage.clear(); 
    location.reload(); 
}

document.addEventListener("DOMContentLoaded", () => {
    if (sessionStorage.getItem('prism_level')) {
        loadArchive();
    }
});
</script>
</body>
</html>







