<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>P.R.I.S.M. | ARCHIVE_EXPLORER</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root { 
            --neon: #00ffcc; 
            --alert: #ff4444; 
            --bg: #050505; 
            --panel: rgba(10, 15, 15, 0.95);
            --border: #1a3a3a;
        }

        * { box-sizing: border-box; }
        body { 
            background: var(--bg); color: #888; 
            font-family: 'Courier New', monospace; margin: 0; 
            text-transform: uppercase; font-size: 13px;
            height: 100vh; overflow: hidden;
        }

        /* Эффекты монитора */
        .overlay { position: fixed; inset: 0; background: repeating-linear-gradient(0deg, rgba(0,0,0,0.1) 0px, transparent 2px); pointer-events: none; z-index: 1000; }
        .scanline { position: fixed; top: 0; left: 0; width: 100%; height: 4px; background: rgba(0, 255, 204, 0.05); z-index: 1001; pointer-events: none; animation: scan 8s linear infinite; }
        @keyframes scan { from { top: -5%; } to { top: 105%; } }

        /* Структура экрана */
        .main-layout {
            display: none; /* До авторизации */
            grid-template-columns: 350px 1fr;
            height: calc(100vh - 60px);
            margin-top: 60px;
        }
        body.authorized .main-layout { display: grid; }

        nav { 
            position: fixed; top: 0; width: 100%; height: 60px;
            background: #000; border-bottom: 1px solid var(--border);
            display: none; align-items: center; justify-content: center; z-index: 500;
        }
        body.authorized nav { display: flex; }
        nav a { color: #555; text-decoration: none; padding: 0 20px; letter-spacing: 2px; }
        nav a:hover { color: var(--neon); }

        /* Левая колонка: Список */
        .sidebar {
            border-right: 1px solid var(--border);
            overflow-y: auto;
            background: rgba(0,0,0,0.5);
            padding: 10px;
        }
        .sidebar::-webkit-scrollbar { width: 4px; }
        .sidebar::-webkit-scrollbar-thumb { background: var(--border); }

        .list-item {
            padding: 15px;
            border: 1px solid transparent;
            margin-bottom: 5px;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .list-item:hover { background: rgba(0, 255, 204, 0.05); border-color: var(--border); }
        .list-item.active { 
            background: rgba(0, 255, 204, 0.1); 
            border-color: var(--neon);
            color: var(--neon);
        }
        .list-item.locked { opacity: 0.5; border-left: 3px solid var(--alert); }

        .mini-avatar { width: 40px; height: 40px; border: 1px solid var(--border); filter: grayscale(1); }

        /* Правая колонка: Просмотр */
        .viewer {
            padding: 40px;
            overflow-y: auto;
            position: relative;
        }
        .placeholder-text {
            height: 100%; display: flex; align-items: center; justify-content: center;
            color: #333; font-size: 1.5em; letter-spacing: 5px;
        }

        .dossier-content {
            display: none; /* Появляется при выборе */
            animation: fadeIn 0.4s ease-out;
        }

        .big-photo-frame {
            width: 200px; height: 200px; border: 1px solid var(--neon);
            padding: 10px; background: #000; float: left; margin: 0 30px 30px 0;
            box-shadow: 0 0 20px rgba(0, 255, 204, 0.1);
        }

        .data-row { margin-bottom: 15px; border-bottom: 1px solid #111; padding-bottom: 5px; }
        .label { color: #555; font-size: 0.8em; }
        .value { color: #fff; font-size: 1.1em; letter-spacing: 1px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Кнопка выхода */
        .btn-exit { position: absolute; top: 15px; right: 20px; border: 1px solid var(--alert); color: var(--alert); background: none; cursor: pointer; padding: 5px 10px; font-family: inherit; }

        /* Окно логина (без изменений) */
        #auth-overlay { position: fixed; inset: 0; background: var(--bg); z-index: 5000; display: flex; align-items: center; justify-content: center; }
        .login-card { border: 1px solid var(--neon); padding: 40px; background: #000; text-align: center; width: 400px; }
        input { background: rgba(0, 255, 204, 0.05); border: 1px solid var(--border); color: var(--neon); padding: 15px; margin: 10px 0; width: 100%; outline: none; font-family: inherit; }
        .btn { background: rgba(0, 255, 204, 0.1); color: var(--neon); border: 1px solid var(--neon); padding: 15px; cursor: pointer; width: 100%; font-family: inherit; margin-top: 15px; }
    </style>
</head>
<body>

<div class="overlay"></div>
<div class="scanline"></div>

<div id="auth-overlay">
    <div class="login-card">
        <h2 style="color: var(--neon); letter-spacing: 5px;">PRISM_LOGIN</h2>
        <input type="text" id="uid" placeholder="PERSONNEL_ID">
        <input type="password" id="ups" placeholder="ACCESS_KEY">
        <button class="btn" onclick="tryLogin()">ACCESS_DATABASE</button>
    </div>
</div>

<nav>
    <a href="index.html">/ MAIN</a>
    <a href="dossier.html" style="color:var(--neon)">/ ARCHIVE_EXPLORER</a>
    <span id="user-display" style="margin-left:auto; padding-right:20px; color:#444;"></span>
    <button class="btn-exit" onclick="logout()">LOGOUT</button>
</nav>

<div class="main-layout">
    <div class="sidebar" id="staff-list">
        </div>
    
    <div class="viewer" id="staff-viewer">
        <div class="placeholder-text" id="placeholder">SELECT_SUBJECT_FOR_ANALYSIS</div>
        
        <div class="dossier-content" id="content-box">
            <div class="big-photo-frame">
                <img id="v-photo" src="" style="width:100%; filter: grayscale(1);">
            </div>
            
            <div style="margin-bottom: 40px;">
                <h1 id="v-name" style="color:var(--neon); margin:0; font-size:2.5em;"></h1>
                <div id="v-level" style="color:var(--alert); font-weight:bold;"></div>
            </div>

            <div class="data-row">
                <div class="label">ASSIGNED_SECTION</div>
                <div class="value" id="v-dept"></div>
            </div>

            <div class="data-row">
                <div class="label">BIOMETRIC_DATA_&_HISTORY</div>
                <div class="value" id="v-bio" style="white-space: pre-wrap; margin-top:10px; color:#aaa; line-height:1.6;"></div>
            </div>
        </div>
    </div>
</div>

<script>
    const RENDER_URL = "https://prism-bot.onrender.com";
    let STAFF_DATA = {};

    async function tryLogin() {
        const id = document.getElementById('uid').value.toUpperCase().trim();
        const rawPass = document.getElementById('ups').value;
        const ps = CryptoJS.MD5(rawPass).toString();

        try {
            const res = await fetch(`${RENDER_URL}/login`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id, pass: ps })
            });
            if (res.ok) {
                const data = await res.json();
                sessionStorage.setItem('prism_level', data.level);
                sessionStorage.setItem('prism_user', data.name);
                location.reload();
            } else { alert("ACCESS_DENIED"); }
        } catch (e) { alert("OFFLINE"); }
    }

    async function loadArchive() {
        const myLevel = parseInt(sessionStorage.getItem('prism_level'));
        if (isNaN(myLevel)) return;

        document.getElementById('auth-overlay').style.display = 'none';
        document.body.classList.add('authorized');
        document.getElementById('user-display').innerText = `OP: ${sessionStorage.getItem('prism_user')}`;

        try {
            const res = await fetch(`${RENDER_URL}/get-staff`);
            STAFF_DATA = await res.json();
            const listContainer = document.getElementById('staff-list');

            for (const [id, p] of Object.entries(STAFF_DATA)) {
                const isLocked = myLevel < p.level;
                const item = document.createElement('div');
                item.className = `list-item ${isLocked ? 'locked' : ''}`;
                item.innerHTML = `
                    <img class="mini-avatar" src="https://minotar.net/avatar/${isLocked ? 'Steve' : p.mc_name}/40.png">
                    <div>
                        <div style="font-weight:bold; color:${isLocked ? '#400' : '#ccc'}">${isLocked ? 'CLASSIFIED' : (p.name || id)}</div>
                        <div style="font-size:0.7em; color:#555;">CLEARANCE: L${p.level}</div>
                    </div>
                `;
                item.onclick = () => selectStaff(id, isLocked);
                listContainer.appendChild(item);
            }
        } catch (e) { console.error(e); }
    }

    function selectStaff(id, isLocked) {
        // Убираем активный класс у всех и даем выбранному
        document.querySelectorAll('.list-item').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');

        const p = STAFF_DATA[id];
        const myLevel = parseInt(sessionStorage.getItem('prism_level'));

        document.getElementById('placeholder').style.display = 'none';
        const box = document.getElementById('content-box');
        box.style.display = 'block';

        if (isLocked) {
            document.getElementById('v-name').innerText = "RESTRICTED_DATA";
            document.getElementById('v-photo').src = "https://minotar.net/armor/bust/Steve/200.png";
            document.getElementById('v-dept').innerText = "REDACTED";
            document.getElementById('v-level').innerText = `CRITICAL: LEVEL ${p.level} CLEARANCE REQUIRED`;
            document.getElementById('v-bio').innerText = "Для доступа к данному досье требуется прямое разрешение Совета P.R.I.S.M. Ваша попытка доступа была зафиксирована.";
        } else {
            document.getElementById('v-name').innerText = p.name || id;
            document.getElementById('v-photo').src = `https://minotar.net/armor/bust/${p.mc_name}/200.png`;
            document.getElementById('v-dept').innerText = p.dept || "GENERAL_UNIT";
            document.getElementById('v-level').innerText = `STATUS: AUTHORIZED (L${p.level})`;
            document.getElementById('v-bio').innerText = ""; // Очищаем для эффекта печати
            typeEffect('v-bio', p.bio || "Биографические данные отсутствуют в базе.");
        }
    }

    function typeEffect(id, text) {
        const el = document.getElementById(id);
        let i = 0;
        const timer = setInterval(() => {
            el.innerText += text.charAt(i);
            i++;
            if (i >= text.length) clearInterval(timer);
        }, 15);
    }

    function logout() { sessionStorage.clear(); location.reload(); }

    document.addEventListener("DOMContentLoaded", () => {
        if (sessionStorage.getItem('prism_level')) loadArchive();
    });
</script>
</body>
</html>
