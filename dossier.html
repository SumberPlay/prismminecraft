<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>P.R.I.S.M. | Личные Дела</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root { --neon: #00ffcc; --bg: #050505; --alert: #ff4444; --panel: #0a0a0a; }
        
        body { 
            background: var(--bg); color: #bbb; font-family: 'Courier New', monospace; 
            margin: 0; padding: 0; min-height: 100vh; transition: background 0.3s;
            overflow-x: hidden;
        }

        .container, nav { 
            display: none; 
            opacity: 0;
            transition: opacity 1s ease-in;
        }

        body.authorized .container, 
        body.authorized nav { display: block; }

        body.authorized.visible .container,
        body.authorized.visible nav { opacity: 1; }

        body.alarm-active { background: #1a0505; }
        body.error-flash { background: #440000 !important; }

        #scanner-line {
            position: fixed; top: -10px; left: 0; width: 100%; height: 4px;
            background: var(--neon); box-shadow: 0 0 20px var(--neon);
            z-index: 6000; pointer-events: none; opacity: 0;
        }
        @keyframes scan-anim { 0% { top: 0%; opacity: 1; } 100% { top: 100%; opacity: 1; } }

        #auth-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 5000;
            display: flex; align-items: center; justify-content: center;
            transition: opacity 0.8s ease-out;
        }

        .login-card { border: 1px solid var(--neon); padding: 40px; background: #000; text-align: center; width: 350px; position: relative; }
        input { background: #000; border: 1px solid #333; color: var(--neon); padding: 12px; margin: 10px 0; width: 100%; box-sizing: border-box; outline: none; }
        
        .btn { background: var(--neon); color: #000; border: none; padding: 12px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; text-transform: uppercase; transition: 0.3s; font-family: inherit; }
        .btn:hover { background: #fff; box-shadow: 0 0 15px #fff; }
        .btn-secondary { background: none; color: #555; border: 1px solid #333; }

        nav { background: #000; padding: 15px; border-bottom: 1px solid #333; text-align: center; }
        nav a { color: #888; text-decoration: none; padding: 0 20px; font-size: 0.9em; }
        nav a:hover { color: var(--neon); }
        
        .container { max-width: 1100px; margin: 40px auto; padding: 0 20px; }
        .header { border-bottom: 2px solid var(--neon); padding-bottom: 10px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
        .dossier-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(450px, 1fr)); gap: 25px; }

        .player-card { background: var(--panel); border: 1px solid #222; display: flex; padding: 20px; position: relative; overflow: hidden; transition: 0.3s; height: 140px; }
        .locked { filter: blur(10px) grayscale(1); pointer-events: none; opacity: 0.3; }
        .lock-text { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: var(--alert); font-weight: bold; z-index: 10; display: none; text-shadow: 0 0 10px var(--alert); letter-spacing: 2px; text-align: center; background: rgba(0,0,0,0.6); }
        
        .photo { width: 100px; height: 100px; border: 1px solid #333; margin-right: 20px; background: #111; object-fit: cover; }
        .name { color: var(--neon); font-size: 1.2em; margin-bottom: 5px; text-transform: uppercase; }
        .status-active { color: #00ff00; border-color: #00ff00; font-size: 0.7em; padding: 2px 8px; border: 1px solid; display: inline-block; margin-bottom: 10px;}
        .bio { font-size: 0.85em; line-height: 1.4; color: #888; overflow-y: auto; max-height: 60px; }
        
        .btn-exit-top { background: none; border: 1px solid var(--alert); color: var(--alert); cursor: pointer; padding: 8px 15px; font-family: monospace; font-size: 0.8em; }
        #sys-indicator { font-size: 0.7em; letter-spacing: 1px; color: #444; }
    </style>
</head>
<body>

<div id="scanner-line"></div>

<div id="auth-overlay">
    <div class="login-card" id="login-card">
        <h2 id="auth-title" style="color: var(--neon); letter-spacing: 3px;">P.R.I.S.M. DATA</h2>
        <p id="sub-title" style="font-size: 0.7em; color: #555;">ОЖИДАНИЕ СИНХРОНИЗАЦИИ...</p>
        
        <div id="auth-form" style="display:none;">
            <input type="text" id="uid" placeholder="ID СОТРУДНИКА">
            <input type="password" id="ups" placeholder="ПАРОЛЬ">
            <button class="btn" onclick="startAuthProcess('admin')">ВХОД</button>
            <button class="btn btn-secondary" onclick="startAuthProcess('guest')">ГОСТЕВОЙ ДОСТУП</button>
            <hr style="border: 0; border-top: 1px solid #222; margin: 20px 0;">
            <button class="btn btn-secondary" style="border-color: var(--alert); color: var(--alert); font-size: 0.8em;" onclick="window.location.href='index.html'">✖ НА ГЛАВНУЮ</button>
        </div>
    </div>
</div>

<nav>
    <a href="index.html">ГЛАВНАЯ</a>
    <a href="dossier.html" style="color: var(--neon);">ЛИЧНЫЕ ДЕЛА</a>
    <a href="staff.html">ТЕРМИНАЛ</a>
</nav>

<div class="container">
    <div class="header">
        <div>
            <h1 style="margin:0; letter-spacing: 2px;">PERSONNEL DOSSIER</h1>
            <div id="sys-indicator">СИНХРОНИЗАЦИЯ: <span id="sync-status">...</span></div>
        </div>
        <div id="exit-container"></div>
    </div>
    <div class="dossier-grid" id="dossier-container">
        </div>
</div>

<script>
    const RENDER_URL = "https://prism-bot.onrender.com";
    let staffDB = {};

    // 1. Загрузка базы из бота
    async function initSystem() {
        try {
            const response = await fetch(`${RENDER_URL}/get-staff`);
            staffDB = await response.json();
            document.getElementById('sub-title').innerText = "БАЗА ДАННЫХ ПОДКЛЮЧЕНА. ВВЕДИТЕ ID.";
            document.getElementById('auth-form').style.display = 'block';
            renderPage();
        } catch (e) {
            document.getElementById('auth-title').innerText = "ОШИБКА СВЯЗИ";
            document.getElementById('sub-title').innerText = "СЕРВЕР P.R.I.S.M. НЕДОСТУПЕН";
        }
    }

    async function syncStatus() {
        try {
            const res = await fetch(`${RENDER_URL}/status`);
            const data = await res.json();
            const el = document.getElementById('sync-status');
            if(el) { el.innerText = data.label; el.style.color = data.color; }
            if (data.state === "RED") document.body.classList.add('alarm-active');
            else document.body.classList.remove('alarm-active');
        } catch (e) { if(document.getElementById('sync-status')) document.getElementById('sync-status').innerText = "OFFLINE"; }
    }

    function startAuthProcess(type) {
        const line = document.getElementById('scanner-line');
        const title = document.getElementById('auth-title');
        const form = document.getElementById('auth-form');
        const overlay = document.getElementById('auth-overlay');

        line.style.animation = "scan-anim 1.5s linear infinite";
        title.innerText = "АНАЛИЗ ДАННЫХ...";
        form.style.opacity = "0.3";
        form.style.pointerEvents = "none";

        setTimeout(() => {
            let success = false;
            let currentId = "GUEST";
            
            if (type === 'guest') {
                localStorage.setItem('prism_level', 1);
                localStorage.setItem('prism_user', 'ГОСТЬ');
                success = true;
            } else {
                const id = document.getElementById('uid').value.toUpperCase();
                const ps = document.getElementById('ups').value;
                const user = staffDB[id];
                
                if (user && CryptoJS.MD5(ps).toString() === user.pass) {
                    localStorage.setItem('prism_level', user.level);
                    localStorage.setItem('prism_user', user.name);
                    currentId = id;
                    success = true;
                }
            }

            if (success) {
                // ОТЧЕТ БОТУ В ТЕЛЕГРАМ
                const userData = staffDB[currentId] || { name: "ГОСТЬ", level: 1 };
                fetch(`${RENDER_URL}/auth-log`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: currentId, name: userData.name, level: userData.level })
                });

                overlay.style.opacity = "0";
                setTimeout(() => {
                    overlay.style.display = "none";
                    renderPage();
                }, 800);
            } else {
                document.body.classList.add('error-flash');
                title.innerText = "ОШИБКА ДОСТУПА";
                setTimeout(() => location.reload(), 1000);
            }
        }, 1500);
    }

    function renderPage() {
        const level = parseInt(localStorage.getItem('prism_level'));
        if (!level) return;

        document.getElementById('auth-overlay').style.display = 'none';
        document.body.classList.add('authorized');
        setTimeout(() => document.body.classList.add('visible'), 50);

        document.getElementById('exit-container').innerHTML = `<button class="btn-exit-top" onclick="localStorage.clear();location.reload();">EXIT SYSTEM</button>`;
        
        const container = document.getElementById('dossier-container');
        container.innerHTML = ''; // Чистим перед рендером

        // Генерируем карточки из загруженной базы
        Object.keys(staffDB).forEach(id => {
            const p = staffDB[id];
            const isLocked = level < p.level;
            const card = document.createElement('div');
            card.className = 'player-card';
            card.innerHTML = `
                <div class="lock-text" style="${isLocked ? 'display:flex' : 'none'}">LEVEL ${p.level} REQUIRED</div>
                <div class="content-wrap ${isLocked ? 'locked' : ''}" style="display:flex; width:100%;">
                    <img src="https://minotar.net/armor/bust/${p.mc_name || 'Steve'}/100.png" class="photo">
                    <div class="info">
                        <div class="name">${p.name}</div>
                        <div class="status-active">ОТДЕЛ: ${p.dept}</div>
                        <div class="bio">${p.bio}</div>
                    </div>
                </div>
            `;
            container.appendChild(card);
        });
        syncStatus();
    }

    document.addEventListener("DOMContentLoaded", () => {
        initSystem();
        setInterval(syncStatus, 5000);
    });
</script>
</body>
</html>
