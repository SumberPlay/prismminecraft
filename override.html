<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>P.R.I.S.M. | COUNCIL_OVERRIDE</title>
    <style>
        :root {
            --gold: #d4af37;
            --gold-dim: #5e4d1a;
            --red: #ff4444;
            --bg: #050505;
            --panel-bg: rgba(15, 15, 15, 0.95);
        }

        * { box-sizing: border-box; }
        body {
            background: var(--bg); color: #ccc; font-family: 'Courier New', monospace;
            margin: 0; display: flex; flex-direction: column; height: 100vh;
            text-transform: uppercase; overflow: hidden;
        }

        /* Сканирующая линия (мягче) */
        body::after {
            content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 1px;
            background: rgba(212, 175, 55, 0.2); box-shadow: 0 0 10px var(--gold);
            animation: scan 10s infinite linear; pointer-events: none; z-index: 1000;
        }
        @keyframes scan { 0% { top: -10%; } 100% { top: 110%; } }

        header {
            padding: 10px 25px; border-bottom: 2px solid var(--gold);
            display: flex; justify-content: space-between; align-items: center;
            background: #000; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        /* Таб-система */
        .tabs { display: flex; background: #111; border-bottom: 1px solid var(--gold-dim); }
        .tab-btn {
            padding: 12px 25px; border: none; background: transparent;
            color: var(--gold-dim); cursor: pointer; font-family: inherit;
            transition: 0.3s; border-right: 1px solid var(--gold-dim);
        }
        .tab-btn.active { background: var(--gold-dim); color: #000; font-weight: bold; }

        .main-layout { display: flex; flex-grow: 1; overflow: hidden; }

        /* Панель управления (слева) */
        .control-panel {
            width: 350px; border-right: 1px solid var(--gold-dim);
            background: var(--panel-bg); display: flex; flex-direction: column;
        }
        .list-container { flex-grow: 1; overflow-y: auto; padding: 10px; }

        /* Элементы списков */
        .item-card {
            padding: 12px; border: 1px solid var(--gold-dim); margin-bottom: 8px;
            cursor: pointer; font-size: 0.8em; transition: 0.2s;
        }
        .item-card:hover { border-color: var(--gold); background: rgba(212,175,55,0.05); }
        .item-card.active { border-color: var(--gold); background: rgba(212,175,55,0.15); box-shadow: inset 0 0 10px rgba(212,175,55,0.1); }

        /* Рабочая зона (справа) */
        .work-zone { flex-grow: 1; padding: 40px; overflow-y: auto; position: relative; }
        .content-block { max-width: 900px; margin: 0 auto; display: none; }
        .content-block.active { display: block; animation: fadeIn 0.4s ease-out; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h2 { color: var(--gold); letter-spacing: 5px; border-bottom: 1px solid var(--gold-dim); padding-bottom: 10px; }

        /* Формы и Инпуты */
        input, select, textarea {
            background: #000; border: 1px solid var(--gold-dim); color: var(--gold);
            padding: 10px; width: 100%; margin: 10px 0; font-family: inherit;
        }
        .btn-gold {
            background: var(--gold); color: #000; border: none; padding: 12px 20px;
            cursor: pointer; font-weight: bold; width: 100%; transition: 0.3s;
        }
        .btn-gold:hover { background: #fff; box-shadow: 0 0 20px var(--gold); }
        .btn-danger { background: #400; color: var(--red); border: 1px solid var(--red); padding: 5px 10px; cursor: pointer; }

        /* Таблица задач */
        .task-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; border-bottom: 1px solid #222; font-size: 0.85em;
        }

        .console-mini {
            height: 120px; background: #000; border-top: 1px solid var(--gold-dim);
            padding: 10px; font-size: 0.7em; color: var(--gold-dim); overflow-y: auto;
        }
    </style>
</head>
<body>

<header>
    <div style="color: var(--gold); letter-spacing: 3px;">[ COUNCIL_OVERRIDE_INTERFACE ]</div>
    <div id="status-display" style="font-size: 0.7em;">SYNCING...</div>
</header>

<div class="tabs">
    <button class="tab-btn active" onclick="switchTab('protocols')">01_PROTOCOLS</button>
    <button class="tab-btn" onclick="switchTab('tasks')">02_TASK_MANAGER</button>
    <button class="tab-btn" onclick="switchTab('personnel')">03_PERSONNEL_DEPT</button>
    <button class="tab-btn" style="border-right:none" onclick="location.href='staff.html'">[ EXIT ]</button>
</div>

<div class="main-layout">
    <div class="control-panel">
        <div class="list-container" id="side-list">
            </div>
    </div>

    <div class="work-zone" id="work-zone">
        
        <div id="mod-protocols" class="content-block active">
            <h2>EMERGENCY_PROTOCOLS</h2>
            <div id="protocol-details" style="margin-top:20px; color:#888;">ВЫБЕРИТЕ ПРОТОКОЛ СЛЕВА ДЛЯ АКТИВАЦИИ...</div>
        </div>

        <div id="mod-tasks" class="content-block">
            <h2>DIRECTIVE_CONTROL</h2>
            <div id="task-user-info" style="margin-bottom:20px; color:var(--gold);">ВЫБЕРИТЕ СОТРУДНИКА...</div>
            
            <div id="task-list-area"></div>

            <div style="margin-top:30px; border: 1px solid #222; padding: 20px; background: rgba(255,255,255,0.02);">
                <span style="font-size:0.7em; color:var(--gold-dim);">НОВАЯ ДИРЕКТИВА:</span>
                <input type="text" id="new-task-text" placeholder="ОПИСАНИЕ ЗАДАЧИ...">
                <button class="btn-gold" onclick="addTask()">НАЗНАЧИТЬ ИСПОЛНЕНИЕ</button>
            </div>
        </div>

        <div id="mod-personnel" class="content-block">
            <h2>PERSONNEL_RECORDS</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px;">
                <div>
                    <h3>РЕГИСТРАЦИЯ ОБЪЕКТА</h3>
                    <input type="text" id="reg-id" placeholder="ID (AGENT_01)">
                    <input type="text" id="reg-name" placeholder="ФИО / ПОЗЫВНОЙ">
                    <input type="text" id="reg-mc" placeholder="MINECRAFT_NAME">
                    <select id="reg-level">
                        <option value="1">УРОВЕНЬ 1</option>
                        <option value="2">УРОВЕНЬ 2</option>
                        <option value="3">УРОВЕНЬ 3</option>
                        <option value="4">УРОВЕНЬ 4</option>
                        <option value="5">УРОВЕНЬ 5 (СОВЕТ)</option>
                    </select>
                    <button class="btn-gold" onclick="registerStaff()">ВНЕСТИ В РЕЕСТР</button>
                </div>
                <div style="border-left: 1px solid #222; padding-left: 40px;">
                    <h3>ДЕАКТИВАЦИЯ</h3>
                    <p style="font-size:0.7em; color:var(--red);">УДАЛЕНИЕ ИЗ БАЗЫ БЕЗВОЗВРАТНО.</p>
                    <div id="delete-target" style="color:var(--gold); margin: 20px 0;">ОБЪЕКТ НЕ ВЫБРАН</div>
                    <button class="btn-danger" style="width:100%; height:50px;" onclick="deleteStaff()">УДАЛИТЬ СОТРУДНИКА</button>
                </div>
            </div>
        </div>

    </div>
</div>

<div class="console-mini" id="console">
    [SYSTEM] COUNCIL_OVERRIDE_V4 INITIALIZED... READY FOR INPUT.
</div>

<script>
    const RENDER_API = "https://prism-bot.onrender.com";
    let currentTab = 'protocols';
    let staffDB = [];
    let selectedUserId = null;

    const PROTOCOLS = [
        { id: "OVR-ST", name: "STABLE_LIGHT", desc: "Сброс всех тревог. Штатный режим освещения." },
        { id: "OVR-RED", name: "RED_CODE", desc: "Блокировка всех гермозатворов. Режим ЧС." },
        { id: "OVR-ZERO", name: "PROTOCOL_ZERO", desc: "Удаление данных. Эвакуация Совета." }
    ];

    async function init() {
        const user = JSON.parse(localStorage.getItem('prism_user'));
        if (!user || user.level < 5) {
            document.body.innerHTML = "<h1 style='color:red; text-align:center; margin-top:100px;'>ACCESS DENIED</h1>";
            return;
        }
        await refreshData();
        renderSideList();
        setInterval(syncStatus, 5000);
    }

    async function refreshData() {
        try {
            const res = await fetch(`${RENDER_API}/get-admin-staff`);
            staffDB = await res.json();
            renderSideList();
        } catch (e) { log("ERR: DATA_SYNC_FAILED"); }
    }

    function switchTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.content-block').forEach(b => b.classList.remove('active'));
        
        event.currentTarget.classList.add('active');
        document.getElementById(`mod-${tab}`).classList.add('active');
        renderSideList();
    }

    function renderSideList() {
        const list = document.getElementById('side-list');
        list.innerHTML = '';

        if (currentTab === 'protocols') {
            PROTOCOLS.forEach(p => {
                const div = document.createElement('div');
                div.className = 'item-card';
                div.innerHTML = `<span style="color:var(--gold)">[${p.id}]</span><br>${p.name}`;
                div.onclick = () => {
                    document.getElementById('protocol-details').innerHTML = `
                        <h3 style="color:var(--gold)">${p.name}</h3>
                        <p>${p.desc}</p>
                        <button class="btn-gold" style="margin-top:20px">АКТИВИРОВАТЬ ЧЕРЕЗ ТГ: ${p.id}_EXECUTE</button>
                    `;
                };
                list.appendChild(div);
            });
        } else {
            staffDB.forEach(user => {
                const div = document.createElement('div');
                div.className = `item-card ${selectedUserId === user.id ? 'active' : ''}`;
                div.innerHTML = `<span style="opacity:0.5">L${user.level}</span> | ${user.name}`;
                div.onclick = () => selectUser(user);
                list.appendChild(div);
            });
        }
    }

    function selectUser(user) {
        selectedUserId = user.id;
        renderSideList();
        
        if (currentTab === 'tasks') {
            document.getElementById('task-user-info').innerText = `СОТРУДНИК: ${user.name} (ID: ${user.id})`;
            const tasksArea = document.getElementById('task-list-area');
            tasksArea.innerHTML = (user.tasks || []).map(t => `
                <div class="task-row">
                    <span>${t.done ? '[X]' : '[ ]'} ${t.text}</span>
                    <button class="btn-danger" onclick="removeTask('${user.id}', '${t.text}')">УДАЛИТЬ</button>
                </div>
            `).join('') || '<p style="opacity:0.3">ЗАДАНИЙ НЕТ</p>';
        } else if (currentTab === 'personnel') {
            document.getElementById('delete-target').innerText = `ЦЕЛЬ: ${user.name} [ID: ${user.id}]`;
        }
    }

    // --- API ВЗАИМОДЕЙСТВИЯ ---

    async function addTask() {
    const textInput = document.getElementById('new-task-text');
    const text = textInput.value.trim();
    if (!selectedUserId || !text) return alert("ВЫБЕРИТЕ ЮЗЕРА И ВВЕДИТЕ ТЕКСТ");
    
    try {
        const res = await fetch(`${RENDER_API}/add-task`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ staff_id: selectedUserId, task_text: text })
        });
        
        if (res.ok) {
            log(`Directive issued for ${selectedUserId}`);
            textInput.value = '';
            await refreshData();
            // Находим юзера уже в обновленной базе
            const updatedUser = staffDB.find(u => u.id === selectedUserId);
            if (updatedUser) selectUser(updatedUser);
        }
    } catch(e) { log("ERR: TASK_ADD_FAILED"); }
}

    async function removeTask(sid, text) {
    if (!confirm("УДАЛИТЬ ДИРЕКТИВУ?")) return;
    try {
        // Отправляем DELETE запрос с параметрами в URL
        const res = await fetch(`${RENDER_API}/remove-task?staff_id=${sid}&task_text=${encodeURIComponent(text)}`, {
            method: 'DELETE'
        });
        
        if (res.ok) {
            log(`Directive removed for ${sid}`);
            await refreshData(); // Сначала обновляем общую базу
            
            // Важно: находим обновленного юзера в новой базе и перерисовываем его задачи
            const updatedUser = staffDB.find(u => u.id === sid);
            if (updatedUser) selectUser(updatedUser); 
        }
    } catch(e) { 
        log("ERR: TASK_DEL_FAILED"); 
    }
}
    async function registerStaff() {
    const idInput = document.getElementById('reg-id');
    const nameInput = document.getElementById('reg-name');
    const mcInput = document.getElementById('reg-mc');
    const lvlInput = document.getElementById('reg-level');

    if (!idInput.value || !nameInput.value) return alert("ЗАПОЛНИТЕ ID И ИМЯ");

    const data = {
        id: idInput.value.trim(),
        name: nameInput.value.trim(),
        mc_name: mcInput.value.trim(), // ИСПРАВЛЕНО ЗДЕСЬ
        level: lvlInput.value
    };
    
    try {
        log(`Registering new subject: ${data.id}...`);
        const res = await fetch(`${RENDER_API}/register-staff`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const result = await res.json();

        if (res.ok) {
            log(`SUCCESS: ${data.id} added. Temporary key: ${result.password}`);
            alert(`ОБЪЕКТ ЗАРЕГИСТРИРОВАН\nВременный ключ: ${result.password}`);
            
            idInput.value = '';
            nameInput.value = '';
            mcInput.value = '';
            
            await refreshData();
        } else {
            log(`ERROR: ${result.error}`);
            alert(`ОБЪЕКТ С ТАКИМ ID УЖЕ СУЩЕСТВУЕТ`);
        }
    } catch(e) { 
        log("ERR: DATABASE_OFFLINE"); 
    }
}

    async function deleteStaff() {
    if (!selectedUserId) return alert("ОБЪЕКТ НЕ ВЫБРАН");
    
    if (!confirm(`КРИТИЧЕСКОЕ ДЕЙСТВИЕ: УДАЛИТЬ ${selectedUserId} ИЗ СИСТЕМЫ БЕЗВОЗВРАТНО?`)) return;

    try {
        log(`Initiating termination for ${selectedUserId}...`);
        
        const res = await fetch(`${RENDER_API}/delete-staff`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ staff_id: selectedUserId })
        });

        if (res.ok) {
            log(`SUCCESS: Subject ${selectedUserId} purged.`);
            selectedUserId = null;
            document.getElementById('delete-target').innerText = "ОБЪЕКТ УДАЛЕН";
            await refreshData(); // Обновляем список слева
        } else {
            const errData = await res.json();
            log(`ERROR: ${errData.error || 'Server rejected request'}`);
        }
    } catch(e) { 
        log("ERR: CONNECTION_LOST_DURING_PURGE"); 
    }
}
    function log(msg) {
        const c = document.getElementById('console');
        const ts = new Date().toLocaleTimeString();
        c.innerHTML += `<br>[${ts}] > ${msg}`;
        c.scrollTop = c.scrollHeight;
    }

    async function syncStatus() {
        try {
            const res = await fetch(`${RENDER_API}/status`);
            const data = await res.json();
            const d = document.getElementById('status-display');
            d.innerText = `SYNC: ${data.label}`;
            d.style.color = data.color;
        } catch(e) { 
            document.getElementById('status-display').style.color = 'red';
            document.getElementById('status-display').innerText = 'SYNC: OFFLINE';
        }
    }

    window.onload = init;
</script>

</body>
</html>



